<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ğŸ“˜ ä¹¦è¯„æµ‹è¯•é¡µé¢ - å¯Œæ–‡æœ¬ç‰ˆ</title>

    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h2 {
            color: #007bff;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            background-color: #0056b3;
        }

        #output {
            background: #2d2d2d;
            color: #00ff80;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            margin-top: 20px;
        }

        .post-content {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: white;
            border-radius: 6px;
            font-size: 16px;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }
    </style>
</head>
<body>

<div class="container">

    <h2>ğŸ“˜ å‘å¸ƒä¹¦è¯„ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬ï¼‰</h2>
    <div class="section">
        <label for="userIdForPublish">ç”¨æˆ·ID:</label>
        <input type="text" id="userIdForPublish" value="1"/>

        <label for="bookIdForPublish">ä¹¦ç±ID:</label>
        <input type="text" id="bookIdForPublish"/>

        <label>å†…å®¹:</label>
        <div id="editor" style="height: 300px;"></div>

        <label for="postTitle">æ ‡é¢˜:</label>
        <input type="text" id="postTitle"/>

        <label for="postImg">å°é¢URL:</label>
        <input type="text" id="postImg"/>

        <button onclick="publishPost()">å‘å¸ƒä¹¦è¯„</button>
    </div>

    <h2>ğŸ“š è·å–ä¹¦ç±æ‰€æœ‰ä¹¦è¯„</h2>
    <div class="section">
        <label for="bookIdForGet">ä¹¦ç±ID:</label>
        <input type="text" id="bookIdForGet"/>
        <button onclick="getBookPosts()">æŸ¥è¯¢ä¹¦è¯„</button>
    </div>

    <h2>ğŸ—‘ï¸ åˆ é™¤ä¹¦è¯„</h2>
    <div class="section">
        <label for="postIdForDelete">å¸–å­ID:</label>
        <input type="text" id="postIdForDelete"/>
        <button onclick="deletePost()">åˆ é™¤ä¹¦è¯„</button>
    </div>

    <h2>âœï¸ æ›´æ–°ä¹¦è¯„</h2>
    <div class="section">
        <label for="postIdForUpdate">å¸–å­ID:</label>
        <input type="text" id="postIdForUpdate"/>

        <label for="updatedTitle">æ–°æ ‡é¢˜:</label>
        <input type="text" id="updatedTitle"/>

        <label>æ–°å†…å®¹:</label>
        <div id="editorUpdate" style="height: 300px;"></div>

        <label for="updatedPostImg">æ–°å°é¢URL:</label>
        <input type="text" id="updatedPostImg"/>

        <button onclick="updatePost()">æ›´æ–°ä¹¦è¯„</button>
    </div>

    <h2>ğŸ” æŸ¥çœ‹ä¹¦è¯„è¯¦æƒ…</h2>
    <div class="section">
        <label for="postIdForGetDetail">å¸–å­ID:</label>
        <input type="text" id="postIdForGetDetail"/>
        <button onclick="getPostDetail()">æŸ¥çœ‹è¯¦æƒ…</button>
    </div>

    <h3>ğŸ“¤ è¾“å‡ºç»“æœ:</h3>
    <pre id="output"></pre>

</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
    function formatOutput(data) {
        return JSON.stringify(data, null, 2);
    }

    async function fetchWithCheck(url, options = {}) {
        const output = document.getElementById('output');
        output.innerText = "åŠ è½½ä¸­...";
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            console.log("ã€è°ƒè¯•ã€‘APIå“åº”ï¼š", result); // è°ƒè¯•ä¿¡æ¯
            return result;
        } catch (error) {
            output.innerText = `é”™è¯¯ï¼š${error.message}`;
            alert("æ“ä½œå¤±è´¥ï¼š" + error.message);
            return null;
        }
    }

    // åˆå§‹åŒ–ä¸»ç¼–è¾‘å™¨
    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                ['image', 'link'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['align', { color: [] }, { background: [] }],
                ['clean']
            ]
        }
    });

    // åˆå§‹åŒ–æ›´æ–°ç¼–è¾‘å™¨
    const quillUpdate = new Quill('#editorUpdate', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                ['image', 'link'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['align', { color: [] }, { background: [] }],
                ['clean']
            ]
        }
    });

    async function publishPost() {
        const userId = parseInt(document.getElementById('userIdForPublish').value);
        const bookId = parseInt(document.getElementById('bookIdForPublish').value);
        const title = document.getElementById('postTitle').value.trim();
        const content = quill.root.innerHTML; // è·å–å¯Œæ–‡æœ¬å†…å®¹ï¼ˆHTMLï¼‰
        const PostImg = document.getElementById('postImg').value.trim();

        if (!userId || !bookId || !title || !content.trim()) {
            alert("è¯·å¡«å†™å®Œæ•´çš„å¿…è¦ä¿¡æ¯");
            return;
        }

        await fetchWithCheck('/post/newPost', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId,
                bookId,
                title,
                content,
                PostImg
            })
        });
    }

    async function getBookPosts() {
        const bookId = parseInt(document.getElementById('bookIdForGet').value);
        if (!bookId) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ä¹¦ç±ID");
            return;
        }

        const result = await fetchWithCheck(`/post/getPostsOfBook/${bookId}`);
        const output = document.getElementById('output');
        output.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

        if (result && Array.isArray(result)) {
            if (result.length > 0) {
                result.forEach(post => {
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post-content';
                    postDiv.innerHTML = `
                        <h4>ğŸ“Œ æ ‡é¢˜: ${post.title}</h4>
                        <hr>
                        ${post.content}
                    `;
                    output.appendChild(postDiv);
                });
            } else {
                output.innerText = 'æš‚æ— ç›¸å…³ä¹¦è¯„ã€‚';
            }
        } else if (result && Array.isArray(result.data)) {
            result.data.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post-content';
                postDiv.innerHTML = `
                    <h4>ğŸ“Œ æ ‡é¢˜: ${post.title}</h4>
                    <hr>
                    ${post.content}
                `;
                output.appendChild(postDiv);
            });
        } else {
            output.innerText = 'æœªæ‰¾åˆ°è¯¥ä¹¦ç±çš„ä»»ä½•ä¹¦è¯„ã€‚';
        }
    }

    async function deletePost() {
        const postId = parseInt(document.getElementById('postIdForDelete').value);
        if (!postId) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¸–å­ID");
            return;
        }
        await fetchWithCheck(`/post/delete/${postId}`, { method: 'DELETE' });
    }

    async function updatePost() {
        const postId = parseInt(document.getElementById('postIdForUpdate').value);
        const title = document.getElementById('updatedTitle').value.trim();
        const content = quillUpdate.root.innerHTML; // è·å–æ›´æ–°çš„å†…å®¹
        const PostImg = document.getElementById('updatedPostImg').value.trim();

        if (!postId) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¸–å­ID");
            return;
        }

        await fetchWithCheck('/post/setPost', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                postId,
                title,
                content,
                PostImg
            })
        });
    }

    async function getPostDetail() {
        const postId = parseInt(document.getElementById('postIdForGetDetail').value);
        if (!postId) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¸–å­ID");
            return;
        }

        const result = await fetchWithCheck(`/post/getPost/${postId}`);
        const output = document.getElementById('output');
        output.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

        if (result && result.data && result.data.content) {
            const post = result.data;
            
            // è·å–å®é™…å†…å®¹
            let content = post.content;
            if (post.content.startsWith('/post/content?file=')) {
                try {
                    const response = await fetch(post.content);
                    if (response.ok) {
                        content = await response.text();
                    }
                } catch (e) {
                    console.error('è·å–å†…å®¹å¤±è´¥:', e);
                }
            }

            const detailDiv = document.createElement('div');
            detailDiv.className = 'post-content';
            detailDiv.innerHTML = `
                <h4>ğŸ“Œ æ ‡é¢˜: ${post.title}</h4>
                <hr>
                <pre>${content}</pre>
            `;
            output.appendChild(detailDiv);
        } else {
            output.innerText = 'æœªæ‰¾åˆ°è¯¥å¸–å­çš„è¯¦ç»†å†…å®¹ã€‚';
        }
    }
</script>

</body>
</html>