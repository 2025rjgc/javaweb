<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>📘 书评测试页面 - 富文本版</title>

    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h2 {
            color: #007bff;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            background-color: #0056b3;
        }

        #output {
            background: #2d2d2d;
            color: #00ff80;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            margin-top: 20px;
        }

        .post-content {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            background-color: white;
            border-radius: 6px;
            font-size: 16px;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }
    </style>
</head>
<body>

<div class="container">

    <h2>📘 发布书评（支持富文本）</h2>
    <div class="section">
        <label for="userIdForPublish">用户ID:</label>
        <input type="text" id="userIdForPublish" value="1"/>

        <label for="bookIdForPublish">书籍ID:</label>
        <input type="text" id="bookIdForPublish"/>

        <label>内容:</label>
        <div id="editor" style="height: 300px;"></div>

        <label for="postTitle">标题:</label>
        <input type="text" id="postTitle"/>

        <label for="postImg">封面URL:</label>
        <input type="text" id="postImg"/>

        <button onclick="publishPost()">发布书评</button>
    </div>

    <h2>📚 获取书籍所有书评</h2>
    <div class="section">
        <label for="bookIdForGet">书籍ID:</label>
        <input type="text" id="bookIdForGet"/>
        <button onclick="getBookPosts()">查询书评</button>
    </div>

    <h2>🗑️ 删除书评</h2>
    <div class="section">
        <label for="postIdForDelete">帖子ID:</label>
        <input type="text" id="postIdForDelete"/>
        <button onclick="deletePost()">删除书评</button>
    </div>

    <h2>✏️ 更新书评</h2>
    <div class="section">
        <label for="postIdForUpdate">帖子ID:</label>
        <input type="text" id="postIdForUpdate"/>

        <label for="updatedTitle">新标题:</label>
        <input type="text" id="updatedTitle"/>

        <label>新内容:</label>
        <div id="editorUpdate" style="height: 300px;"></div>

        <label for="updatedPostImg">新封面URL:</label>
        <input type="text" id="updatedPostImg"/>

        <button onclick="updatePost()">更新书评</button>
    </div>

    <h2>🔍 查看书评详情</h2>
    <div class="section">
        <label for="postIdForGetDetail">帖子ID:</label>
        <input type="text" id="postIdForGetDetail"/>
        <button onclick="getPostDetail()">查看详情</button>
    </div>

    <h3>📤 输出结果:</h3>
    <pre id="output"></pre>

</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
    function formatOutput(data) {
        return JSON.stringify(data, null, 2);
    }

    async function fetchWithCheck(url, options = {}) {
        const output = document.getElementById('output');
        output.innerText = "加载中...";
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            console.log("【调试】API响应：", result); // 调试信息
            return result;
        } catch (error) {
            output.innerText = `错误：${error.message}`;
            alert("操作失败：" + error.message);
            return null;
        }
    }

    // 初始化主编辑器
    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                ['image', 'link'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['align', { color: [] }, { background: [] }],
                ['clean']
            ]
        }
    });

    // 初始化更新编辑器
    const quillUpdate = new Quill('#editorUpdate', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                ['image', 'link'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['align', { color: [] }, { background: [] }],
                ['clean']
            ]
        }
    });

    async function publishPost() {
        const userId = parseInt(document.getElementById('userIdForPublish').value);
        const bookId = parseInt(document.getElementById('bookIdForPublish').value);
        const title = document.getElementById('postTitle').value.trim();
        const content = quill.root.innerHTML; // 获取富文本内容（HTML）
        const PostImg = document.getElementById('postImg').value.trim();

        if (!userId || !bookId || !title || !content.trim()) {
            alert("请填写完整的必要信息");
            return;
        }

        await fetchWithCheck('/post/newPost', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId,
                bookId,
                title,
                content,
                PostImg
            })
        });
    }

    async function getBookPosts() {
        const bookId = parseInt(document.getElementById('bookIdForGet').value);
        if (!bookId) {
            alert("请输入有效的书籍ID");
            return;
        }

        const result = await fetchWithCheck(`/post/getPostsOfBook/${bookId}`);
        const output = document.getElementById('output');
        output.innerHTML = ''; // 清空旧内容

        if (result && Array.isArray(result)) {
            if (result.length > 0) {
                result.forEach(post => {
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post-content';
                    postDiv.innerHTML = `
                        <h4>📌 标题: ${post.title}</h4>
                        <hr>
                        ${post.content}
                    `;
                    output.appendChild(postDiv);
                });
            } else {
                output.innerText = '暂无相关书评。';
            }
        } else if (result && Array.isArray(result.data)) {
            result.data.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post-content';
                postDiv.innerHTML = `
                    <h4>📌 标题: ${post.title}</h4>
                    <hr>
                    ${post.content}
                `;
                output.appendChild(postDiv);
            });
        } else {
            output.innerText = '未找到该书籍的任何书评。';
        }
    }

    async function deletePost() {
        const postId = parseInt(document.getElementById('postIdForDelete').value);
        if (!postId) {
            alert("请输入有效的帖子ID");
            return;
        }
        await fetchWithCheck(`/post/delete/${postId}`, { method: 'DELETE' });
    }

    async function updatePost() {
        const postId = parseInt(document.getElementById('postIdForUpdate').value);
        const title = document.getElementById('updatedTitle').value.trim();
        const content = quillUpdate.root.innerHTML; // 获取更新的内容
        const PostImg = document.getElementById('updatedPostImg').value.trim();

        if (!postId) {
            alert("请输入有效的帖子ID");
            return;
        }

        await fetchWithCheck('/post/setPost', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                postId,
                title,
                content,
                PostImg
            })
        });
    }

    async function getPostDetail() {
        const postId = parseInt(document.getElementById('postIdForGetDetail').value);
        if (!postId) {
            alert("请输入有效的帖子ID");
            return;
        }

        const result = await fetchWithCheck(`/post/getPost/${postId}`);
        const output = document.getElementById('output');
        output.innerHTML = ''; // 清空旧内容

        if (result && result.data && result.data.content) {
            const post = result.data;
            
            // 获取实际内容
            let content = post.content;
            if (post.content.startsWith('/post/content?file=')) {
                try {
                    const response = await fetch(post.content);
                    if (response.ok) {
                        content = await response.text();
                    }
                } catch (e) {
                    console.error('获取内容失败:', e);
                }
            }

            const detailDiv = document.createElement('div');
            detailDiv.className = 'post-content';
            detailDiv.innerHTML = `
                <h4>📌 标题: ${post.title}</h4>
                <hr>
                <pre>${content}</pre>
            `;
            output.appendChild(detailDiv);
        } else {
            output.innerText = '未找到该帖子的详细内容。';
        }
    }
</script>

</body>
</html>